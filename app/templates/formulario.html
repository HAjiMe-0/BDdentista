<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Historial Clínico</title>
</head>
<body>
    <h1>Formulario de Historial Clínico</h1>
    <form id="formularioClinico">
        <input type="hidden" id="paciente_id" value="{{ paciente.paciente_id }}">

        <!-- SECCIÓN 1: Información Básica del Paciente -->
        <h2>Información Básica del Paciente</h2>
        <p><strong>Nombre completo:</strong> <span id="nombre_completo"></span></p>
        <p><strong>Cédula de Identidad:</strong> <span id="ci"></span></p>
        <p><strong>Fecha de nacimiento:</strong> <span id="fecha_nacimiento"></span></p>
        <p><strong>Estado civil:</strong> <span id="estado_civil"></span></p>
        <p><strong>Ocupación:</strong> <span id="ocupacion"></span></p>
        <p><strong>Dirección:</strong> <span id="direccion"></span></p>
        <p><strong>Teléfono fijo:</strong> <span id="telefono"></span></p>
        <p><strong>Celular:</strong> <span id="celular"></span></p>

        <!-- SECCIÓN 2: Antecedentes Médicos -->
        <h2>Antecedentes Médicos</h2>

        <!-- Preguntas Generales -->
        <label>1. ¿Ha tenido alguna operación o enfermedad grave?</label><br>
        <textarea name="operaciones"></textarea><br><br>

        <label>2. ¿Ha tenido alguna de las siguientes enfermedades?</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Fiebre reumática"> Fiebre reumática</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Cardiopatía"> Cardiopatía</label>
        <input type="text" name="detalle_cardiopatia" placeholder="Detalle (opcional)"><br>
        <label><input type="checkbox" name="enfermedades[]" value="Enfermedades respiratorias"> Enfermedades respiratorias</label>
        <input type="text" name="detalle_respiratorias" placeholder="Detalle (opcional)"><br>
        <label><input type="checkbox" name="enfermedades[]" value="Enfermedades renales"> Enfermedades renales</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Asma"> Asma</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Mareos"> Mareos</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Diabetes"> Diabetes</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Artritis"> Artritis</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Úlcera gástrica"> Úlcera gástrica</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Tuberculosis"> Tuberculosis</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Enfermedades venéreas"> Enfermedades venéreas</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Presión alta"> Presión alta</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Presión baja"> Presión baja</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Hepatitis"> Hepatitis</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="Sinusitis"> Sinusitis</label><br>
        <label><input type="checkbox" name="enfermedades[]" value="VIH/SIDA"> VIH/SIDA</label><br>
        <label>¿A qué es alérgico?</label>
        <input type="text" name="alergias"><br><br>

        <label>3. ¿Siente dolor en el tórax después de hacer ejercicio?</label>
        <input type="radio" name="dolor_torax" value="Sí"> Sí
        <input type="radio" name="dolor_torax" value="No"> No<br><br>

        <label>4. ¿Le falta aire después del ejercicio?</label>
        <input type="radio" name="falta_aire" value="Sí"> Sí
        <input type="radio" name="falta_aire" value="No"> No<br><br>

        <label>5. ¿Ha sangrado de forma anormal después de una extracción?</label>
        <input type="radio" name="sangrado_anormal" value="Sí"> Sí
        <input type="radio" name="sangrado_anormal" value="No"> No<br><br>

        <label>6. ¿Ha tenido algún problema grave asociado con algún tratamiento odontológico?</label>
        <input type="radio" name="problema_odontologico" value="Sí"> Sí
        <input type="radio" name="problema_odontologico" value="No"> No<br><br>

        <label>7. ¿Ha tenido alguna enfermedad, proceso o problema no relacionado con la odontología?</label>
        <input type="radio" name="problema_no_odontologico" value="Sí"> Sí
        <input type="radio" name="problema_no_odontologico" value="No"> No<br><br>

        <label>8. ¿Está tomando algún tipo de medicamento o fármaco?</label>
        <input type="radio" name="medicamento" value="Sí"> Sí
        <input type="radio" name="medicamento" value="No"> No<br><br>

        <label>9. ¿Ha tenido reacciones adversas a medicamentos?</label>
        <input type="radio" name="reacciones_medicamentos" value="Sí"> Sí
        <input type="radio" name="reacciones_medicamentos" value="No"> No<br>
        <label>¿Cuál?</label>
        <input type="text" name="detalle_reacciones_medicamentos"><br><br>

        <label>10. Acostumbra:</label><br>
        <label><input type="checkbox" name="costumbres[]" value="Fumar"> Fumar</label><br>
        <label><input type="checkbox" name="costumbres[]" value="Beber"> Beber</label><br>
        <label><input type="checkbox" name="costumbres[]" value="Rechinar los dientes"> Rechinar los dientes</label><br>
        <label><input type="checkbox" name="costumbres[]" value="Roncar"> Roncar</label><br>
        <label><input type="checkbox" name="costumbres[]" value="Respirar por la boca"> Respirar por la boca</label><br>
        <label><input type="checkbox" name="costumbres[]" value="Morderse los labios o la lengua"> Morderse los labios o la lengua</label><br>
        <label><input type="checkbox" name="costumbres[]" value="Chuparse el dedo"> Chuparse el dedo</label><br><br>

        <label>11. ¿Tiene algún problema con:</label><br>
        <label><input type="checkbox" name="problemas[]" value="Riñones"> Riñones</label><br>
        <label><input type="checkbox" name="problemas[]" value="Pulmones"> Pulmones</label><br>
        <label><input type="checkbox" name="problemas[]" value="Hígado"> Hígado</label><br>
        <label><input type="checkbox" name="problemas[]" value="Articulaciones"> Articulaciones</label><br>
        <label><input type="checkbox" name="problemas[]" value="Otros"> Otros</label><br><br>

        <label>12. ¿Ud. ha tenido en los últimos 14 días:</label><br>
        <label><input type="checkbox" name="ultimos_14[]" value="Problemas respiratorios"> Problemas respiratorios</label><br>
        <label><input type="checkbox" name="ultimos_14[]" value="Fiebre"> Fiebre</label><br>
        <label><input type="checkbox" name="ultimos_14[]" value="Dolor muscular"> Dolor muscular</label><br>
        <label><input type="checkbox" name="ultimos_14[]" value="Contacto con pacientes COVID-19"> Contacto con pacientes COVID-19</label><br>
        <label><input type="checkbox" name="ultimos_14[]" value="Viajes a lugares de riesgo COVID-19"> Viajes a lugares de riesgo COVID-19</label><br><br>

        <!-- Exclusivo para mujeres -->
        <label>13. ¿Está usted embarazada?</label>
        <input type="radio" name="embarazo" value="Sí"> Sí
        <input type="radio" name="embarazo" value="No"> No<br>
        <label>¿Cuántas semanas?</label>
        <input type="number" name="semanas_embarazo" placeholder="Si aplica"><br><br>

        <label>14. Observaciones</label><br>
        <textarea name="observaciones"></textarea><br><br>

        <!-- Declaración -->
        <h3>15. Declaración</h3>
        <p>El paciente declara haber entendido todas las explicaciones...</p>

        <button type="button" onclick="guardarFormulario()">Guardar</button>
        <a href="{{ url_for('main.list_paciente') }}" class="btn btn-secondary">Volver</a>
    </form>
    <script>
    async function guardarFormulario() {
    const pacienteId = document.getElementById('paciente_id').value;
    const form = document.getElementById('formularioClinico');
    const formData = new FormData(form);

    const preguntaRespuesta = {};
    formData.forEach((value, key) => {
        if (preguntaRespuesta[key]) {
            if (!Array.isArray(preguntaRespuesta[key])) {
                preguntaRespuesta[key] = [preguntaRespuesta[key]];
            }
            preguntaRespuesta[key].push(value);
        } else {
            preguntaRespuesta[key] = value;
        }
    });

    const data = {
        paciente_id: pacienteId,
        pregunta_respuesta: preguntaRespuesta
    };

    console.log("Datos enviados al backend:", data); // Verifica los datos enviados

    try {
        const response = await fetch('/guardar_historial', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        alert(result.message);
    } catch (error) {
        console.error("Error al guardar el formulario:", error);
        alert('Error al guardar el historial.');
    }
}

</script>
</body>
</html>
